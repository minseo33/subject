<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"> <!--hymeleaf 속성 사용-->

<head>
	<meta charset="UTF-8">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
	<style>
		a {
			text-decoration: none;
		}

		table {
			border-collapse: collapse;
			width: 1000px;
			margin-top: 20px;
			text-align: center;
		}

		td,
		th {
			border: 1px solid black;
			height: 50px;
		}

		th {
			font-size: 17px;
		}

		thead {
			font-weight: 700;
		}

		.table_wrap {
			margin: 50px 0 0 50px;
		}

		.bno_width {
			width: 12%;
		}

		.writer_width {
			width: 20%;
		}

		.regdate_width {
			width: 15%;
		}

		.updatedate_width {
			width: 15%;
		}

		.top_btn {
			font-size: 20px;
			padding: 6px 12px;
			background-color: #fff;
			border: 1px solid #ddd;
			font-weight: 600;
		}
	</style>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
		$(document).ready(function () { // 페이지 로딩 시 데이터 가져오기 //로딩시 블록단위 실행된다고 이해
			var page = 1;
			//ssr Controller의 @RequestParam(defaultValue = "1") int page 와 같음
			var pageSize = document.getElementById("pageSize").value;
			// document의 pazesize라는 id값을 가진 요소의 value값을 pagesize라는 변수에 담음
			fetchBoardData(page, pageSize); //페이지 열릴시 동작
			//alert("page"); //알림창은 잘 뜸
			//alert("pageSize");
		});
		
		
		// 서버(BoardApiController)에서 게시판 데이터를 가져오는 함수(page, pageSize를 인수로 받음)
		// 객체를 생성(data)하고,이 데이터를 서버로 전송하기 위한 AJAX 요청에 사용할 수 있다.
		function fetchBoardData(page, pageSize) { //받은 데이터를 data 객체에 저장 함수
			
			var data = { //data에 저장 -> AJAX 요청에서 서버로 전송될 때 사용됨
				page : page, //페이지 번호
				pageSize : pageSize //페이지크기
			} 

			$.ajax({
				url: '/api/board', // 서버의 URL 주소 //BoardApiController
				type: 'POST', //http 요청 방식(GET, POST, PUT등)
				data: JSON.stringify(data), // 데이터 객체를 JSON 문자열로 변환하여 전송(Controller(즉, 서버)에게)
				contentType: 'application/json', // 전송하는 데이터의 형식 (JSON)
				//dataType: 'json', //서버에서 보내줄 데이터 타입
				success: function (data) { //서버로부터 정상적으로 응답이 왔을 때 실행 
					//api/board를 요청했을때 받은 데이터가 (data)
					
					var tableBody = $('#boardData'); //리스트가 담길 영역을 선택 
					var paging = $('#paging'); //페이징 처리 html이 담길 영역을 선택
					console.log(data)
					
					tableBody.empty() //해당 영역을 초기화하고 새롭게 받아온 데이터로 세팅을 하기위해서 사용


					// JSON 데이터 반복
					$.each(data.boardData, function (index, item) {
						var row = '<tr>' +
							'<td>' + (index + 1) + '</td>' + // 번호는 index + 1
							'<td>' + item.subject + '</td>' +
							'<td>' + item.contents + '</td>' +
							'<td>' + item.writer + '</td>' +
							'<td>' + new Date(item.registerTime).toLocaleString() + '</td>' +
							'</tr>';

						tableBody.append(row); //만들어진 html코드를 선택된 영역에 추가
					});

					var paginationHtml = ''; //paginationHtml변수는 pagination을 HTML 문자열 형태로 구성하겠다 라는 뜻
					//동적으로 생성하는데 사용 -> 페이지가 변경될 때 해당 페이지로 이동
					
					paginationHtml = '<nav aria-label="Page navigation example"><ul class="pagination">';

					// 처음 페이지로 이동하는 링크
					paginationHtml += `<li class="page-item"><a class="page-link" aria-label="Previous"><span onclick="fetchBoardData(1, ${data.pageSize})" aria-hidden="true">처음</span></a></li>`;

					// 이전 블록으로 이동하는 링크
					paginationHtml += `<li class="page-item"><a class="page-link" onclick="fetchBoardData(${data.pagination.prevBlock}, ${data.pageSize})" aria-label="Previous"><span aria-hidden="true">이전</span></a></li>`;
					

					// 페이지 번호 링크 (for 루프로 생성)
					for (var i = data.pagination.startPage; i <= data.pagination.endPage; i++) {
						paginationHtml += `<li class="page-item"><a class="page-link" onclick="fetchBoardData(${i}, ${data.pageSize})">${i}</a></li>`;
					}

					// 다음 블록으로 이동하는 링크
					paginationHtml += `<li class="page-item"><a class="page-link" onclick="fetchBoardData(${data.pagination.nextBlock}, ${data.pageSize})" aria-label="Next"><span aria-hidden="true">다음</span></a></li>`;

					// 끝 페이지로 이동하는 링크
					paginationHtml += `<li class="page-item"><a class="page-link" onclick="fetchBoardData(${data.pagination.totalPageCnt}, ${data.pageSize})" aria-label="Previous"><span aria-hidden="true">끝</span></a></li>`;
					
					paginationHtml += '</ul></nav>';
					
					//paginationHtml 코드를 실행하면 paging 요소의 내부 HTML이 위의 페이지네이션으로 설정되어 화면에 나타난다
					paging.html(paginationHtml);
				},
				error: function () { // 서버로부터 응답이 정상적으로 처리되지 못했을 때 실행
					console.error('게시판 데이터를 가져오는 중 오류 발생.');
				} //오류처리......
			});
		}
		
		function chgPageSize() { //onchange 실행
			var pageSize = document.getElementById("pageSize").value;
			fetchBoardData(1, pageSize); //콤보박스 값 변경시 해당 표출갯수만큼 보여지고 1페이지로 이동
		}

	</script>
</head>

<body>
	<h1 th:text="'게시판'">직접 입력</h1>
	<div class="table_wrap">
		<table>
			<thead>
				<tr>
					<th>번호</th>
					<th>제목</th>
					<th>내용</th>
					<th>작성자</th>
					<th>작성일시</th>
				</tr>
			</thead>
			<tbody id="boardData">

			</tbody>
		</table>
		
		<label for="lang">페이지당노출수</label>
		<select name="languages" id="pageSize" onchange="chgPageSize()"> <!--onchange = chgPageSize() 값이 변경되면 chgPageSize가 실행됨.-->
			<option value=10>10</option>
			<option value=20>20</option>
			<option value=30>30</option>
		</select>

		<div id="paging">

		</div>
	</div>
</body>

</html>